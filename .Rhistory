# Définir les critères de recherche
codes_ape <- c("90", "91", "92", "93")
base_url <- "https://api.insee.fr/entreprises/sirene/V3.11/siret"
api_key <- "dd176d5c-6027-319e-8c42-7fc888ab5368"
library(httr)
library(dplyr)
library(jsonlite)
# Fonction pour récupérer les données
get_establishments_by_ape_code <- function(ape_codes) {
communes <- c()
for (code in ape_codes) {
query <- paste0("activitePrincipaleUniteLegale:", code, "* AND etatAdministratifUniteLegale:A")
res <- GET(
base_url,
add_headers(Authorization = paste("Bearer", api_key)),
query = list(q = query)
)
if (status_code(res) == 200) {
data <- fromJSON(content(res, as = "text"))
# Extraire les communes
if (!is.null(data$etablissement)) {
communes <- c(communes, sapply(data$etablissement, function(x) x$adresseEtablissement$communeEtablissement))
}
} else {
warning("Erreur lors de la récupération des données pour le code APE: ", code)
}
}
return(unique(communes))
}
# Récupérer les données
unique_communes <- get_establishments_by_ape_code(codes_ape)
